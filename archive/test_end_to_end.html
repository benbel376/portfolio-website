<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>End-to-End Test: Dictionary-Driven Architecture</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 3px; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        iframe { width: 100%; height: 500px; border: 1px solid #ccc; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        #dynamic-test-results { max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 10px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>üß™ End-to-End Test: Dictionary-Driven Architecture</h1>
    
    <div class="test-section">
        <h2>Test 1: Full Website Load</h2>
        <p>Testing complete website loading with new dictionary system</p>
        <iframe id="main-site" src="http://localhost:8080"></iframe>
        <div id="load-test-result" class="test-result info">Loading website...</div>
    </div>
    
    <div class="test-section">
        <h2>Test 2: Navigation System</h2>
        <p>Test navigation tabs and state management</p>
        <button onclick="testNavigation('summary')">Test Summary Tab</button>
        <button onclick="testNavigation('projects')">Test Projects Tab</button>
        <button onclick="testNavigation('experience')">Test Experience Tab</button>
        <button onclick="testNavigation('education')">Test Education Tab</button>
        <div id="nav-test-results" class="test-result info">Click buttons to test navigation</div>
    </div>
    
    <div class="test-section">
        <h2>Test 3: Dynamic Content Loading</h2>
        <p>Test dynamic component loading through API</p>
        <button onclick="testDynamicComponent('project-details-main', 'project_details_page_t1.json')">Load Project Details</button>
        <button onclick="testDynamicComponent('summary-main-container', 'summary_page_t1.json')">Load Summary Container</button>
        <div id="dynamic-test-results"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 4: Protected Content</h2>
        <p>Test authentication flow for protected components</p>
        <button onclick="testProtectedContent('admin-placeholder', 'control_page_t1.json')">Test Admin Content (Protected)</button>
        <button onclick="simulateLogin()">Simulate Login</button>
        <button onclick="simulateLogout()">Simulate Logout</button>
        <div id="auth-test-results" class="test-result info">Test protected content access</div>
    </div>
    
    <div class="test-section">
        <h2>Test 5: Security Enforcement</h2>
        <p>Verify security rules: protected = dynamic on initial load</p>
        <button onclick="checkSecurityEnforcement()">Check Security Rules</button>
        <div id="security-test-results" class="test-result info">Click to test security enforcement</div>
    </div>

    <script>
        // Test 1: Website Load Check
        document.getElementById('main-site').onload = function() {
            const result = document.getElementById('load-test-result');
            try {
                const iframe = this;
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                
                if (iframeDoc.body && iframeDoc.body.innerHTML.trim()) {
                    result.className = 'test-result success';
                    result.innerHTML = '‚úÖ Website loaded successfully with dictionary system';
                } else {
                    result.className = 'test-result error';
                    result.innerHTML = '‚ùå Website loaded but appears empty';
                }
            } catch (e) {
                result.className = 'test-result error';
                result.innerHTML = '‚ùå Error accessing iframe content: ' + e.message;
            }
        };
        
        // Test 2: Navigation
        function testNavigation(section) {
            const result = document.getElementById('nav-test-results');
            result.className = 'test-result info';
            result.innerHTML = `Testing navigation to ${section}...`;
            
            try {
                const iframe = document.getElementById('main-site');
                const iframeWindow = iframe.contentWindow;
                
                // Try to access the navigation function
                if (iframeWindow.GlobalNavigator) {
                    iframeWindow.GlobalNavigator.navigateTo(`#${section}`);
                    setTimeout(() => {
                        result.className = 'test-result success';
                        result.innerHTML = `‚úÖ Navigation to ${section} triggered successfully`;
                    }, 1000);
                } else {
                    result.className = 'test-result error';
                    result.innerHTML = '‚ùå GlobalNavigator not found in iframe';
                }
            } catch (e) {
                result.className = 'test-result error';
                result.innerHTML = '‚ùå Navigation test failed: ' + e.message;
            }
        }
        
        // Test 3: Dynamic Content Loading
        function testDynamicComponent(componentId, pageDefinition) {
            const results = document.getElementById('dynamic-test-results');
            const testId = Date.now();
            
            results.innerHTML += `<div id="test-${testId}">üîÑ Testing ${componentId}...</div>`;
            
            const postData = JSON.stringify({
                componentId: componentId,
                pageDefinition: pageDefinition
            });
            
            fetch('http://localhost:8080/endpoints/dynamic_content_t1.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: postData
            })
            .then(response => response.json())
            .then(data => {
                const testDiv = document.getElementById(`test-${testId}`);
                if (data.success) {
                    testDiv.innerHTML = `‚úÖ ${componentId}: Success (${data.objectCount} objects, ${data.content.length} chars)`;
                    testDiv.className = 'success';
                } else {
                    testDiv.innerHTML = `‚ùå ${componentId}: ${data.error}`;
                    testDiv.className = 'error';
                }
            })
            .catch(error => {
                const testDiv = document.getElementById(`test-${testId}`);
                testDiv.innerHTML = `‚ùå ${componentId}: Network error - ${error.message}`;
                testDiv.className = 'error';
            });
        }
        
        // Test 4: Protected Content
        function testProtectedContent(componentId, pageDefinition) {
            const result = document.getElementById('auth-test-results');
            result.className = 'test-result info';
            result.innerHTML = 'Testing protected content access...';
            
            const postData = JSON.stringify({
                componentId: componentId,
                pageDefinition: pageDefinition
            });
            
            fetch('http://localhost:8080/endpoints/dynamic_content_t1.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: postData
            })
            .then(response => {
                if (response.status === 401) {
                    result.className = 'test-result success';
                    result.innerHTML = '‚úÖ Protected content correctly blocked (401 Unauthorized)';
                } else {
                    return response.json().then(data => {
                        if (data.success) {
                            result.className = 'test-result success';
                            result.innerHTML = '‚úÖ Protected content accessible (user authenticated)';
                        } else {
                            result.className = 'test-result error';
                            result.innerHTML = '‚ùå Unexpected response: ' + data.error;
                        }
                    });
                }
            })
            .catch(error => {
                result.className = 'test-result error';
                result.innerHTML = '‚ùå Test failed: ' + error.message;
            });
        }
        
        function simulateLogin() {
            // This would typically be done through the actual login system
            const result = document.getElementById('auth-test-results');
            result.className = 'test-result info';
            result.innerHTML = '‚ö†Ô∏è Login simulation not implemented (requires backend session management)';
        }
        
        function simulateLogout() {
            const result = document.getElementById('auth-test-results');
            result.className = 'test-result info';
            result.innerHTML = '‚ö†Ô∏è Logout simulation not implemented (requires backend session management)';
        }
        
        // Test 5: Security Enforcement
        function checkSecurityEnforcement() {
            const result = document.getElementById('security-test-results');
            result.className = 'test-result info';
            result.innerHTML = 'Checking security enforcement in page source...';
            
            try {
                const iframe = document.getElementById('main-site');
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                const htmlContent = iframeDoc.documentElement.outerHTML;
                
                // Check for dynamic shells (protected content should show as shells initially)
                const hasDynamicShells = htmlContent.includes('data-dynamic="true"') || 
                                       htmlContent.includes('dynamic-shell') ||
                                       htmlContent.includes('loading-placeholder');
                
                if (hasDynamicShells) {
                    result.className = 'test-result success';
                    result.innerHTML = '‚úÖ Security enforcement working: Protected content showing as shells';
                } else {
                    result.className = 'test-result info';
                    result.innerHTML = '‚ö†Ô∏è No dynamic shells detected (may be expected if no protected content on main page)';
                }
            } catch (e) {
                result.className = 'test-result error';
                result.innerHTML = '‚ùå Security check failed: ' + e.message;
            }
        }
        
        // Auto-run some tests
        setTimeout(() => {
            checkSecurityEnforcement();
        }, 3000);
    </script>
</body>
</html>
